### Create an environment for compiling the code
# from any folder, in your tmux session
conda deactivate
conda create -n smcpp_vtk38 -y -c conda-forge \
  python=3.8 cmake ninja git patch \
  gcc_linux-64 gxx_linux-64 \
  vtk tbb tbb-devel
conda activate smcpp_vtk38

# helpful for CMake to find things
export CMAKE_PREFIX_PATH="$CONDA_PREFIX"

ls "$CONDA_PREFIX/lib/cmake" | grep -E '^vtk-9\.' -n
ls "$CONDA_PREFIX/lib/cmake/TBB" -1

# Attention! Case-sensitive rename required for HLBFGS.
# The original guide has an issue with the folder name.
cd ~/workspace/src/PSM2025/external
mv HLBFGS hlbfgs

# Configure & build PSM2025 using this env
cd ~/PSM2025
rm -rf build_cmake
mkdir build_cmake && cd build_cmake

cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_C_COMPILER="$CONDA_PREFIX/bin/x86_64-conda-linux-gnu-cc" \
  -DCMAKE_CXX_COMPILER="$CONDA_PREFIX/bin/x86_64-conda-linux-gnu-c++" \
  -DCMAKE_PREFIX_PATH="$CONDA_PREFIX;$CONDA_PREFIX/lib/cmake" \
  -DVTK_DIR="$CONDA_PREFIX/lib/cmake/$(ls "$CONDA_PREFIX/lib/cmake" | grep -E '^vtk-9\.' | head -n1)" \
  -DTBB_DIR="$CONDA_PREFIX/lib/cmake/TBB"

# Run successful, but need extra libs [GSL] for the env
conda install -y -c conda-forge gsl

# Make using ninja (with log in build.log)
ninja -j"$(nproc)" | tee build.log

# To run PSM2025, use the following commands
# Change directory to a new run folder
# The original branch2,3,4 folders are deleted to save space
cd ~/workspace/src/PSM2025
rm -rf run/quicktest_branch2
mkdir -p run/quicktest_branch3
cp bin/shell run/quicktest_branch3/
cd run/quicktest_branch3

# run
./shell -sim monolayer_growth -case basic_disk -h 0.01 -innerR 0.05 -res 128 -s1 0.05 -s2 0.0

# Test run
time ./shell \
  -sim bilayer_growth \
  -case custom \
  -geometry rectangle \
  -lx 0.025 -ly 0.025 \
  -res 0.01 \
  -h_total 0.0005 \
  -growth_type homo \
  -growth_top  0.002 \
  -growth_bot -0.001 \
  -growth_angle 0.0 \
  -ortho_coeff 0.0 \
  -nsteps 5